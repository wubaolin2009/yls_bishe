{% extends "yls_app/base.html" %}

{% block title %} 微博抓取 {% endblock %}

{% block content %}

<div class="row">
  <div class="col-md-3">
      新建抓取任务 <br>
      当前状态:  {{status}} <br>
      {{content}}
      {% if qq_status.0 == False %}
      <a href='{{qq_status.1}}' class="btn btn-danger" type="button">请先登录qq微博</a>
      {% else %}
      <a class="btn btn-primary" href='/yls_app/fetch_relations' type="button">抓取收听关系</a>
      <a class="btn btn-warning" href='/yls_app/show_relations' type='button'> 查看关系  </a>
      <a href='/yls_app/fetch_weibo' class="btn btn-success" type="button">抓取qq微博</a>
      {% endif %}
      <br>
      <a href='/yls_app/view_weibouser' class="btn btn-warning" type="button">查看微博用户</a><br>
      <a href='/yls_app/start_cut' class="btn btn-success" type="button">开始分词</a><br>
      <a href='/yls_app/view_meaningful_words' class="btn btn-danger" type="button">查看有意义词</a><br>
      <a href='/yls_app/convert_to_final_dict' class="btn btn-primary" type="button">转换最终词典</a><br>
      <a class="btn btn-warning" href='/yls_app/start_lda' type="button">开始LDA</a><br>
      <a class="btn btn-warning" href='/yls_app/run_at_lda' type="button">开始AT</a><br>
      <a class="btn btn-primary" href='/yls_app/run_iat_lda' type="button">开始IAT</a><br>
      <a class="btn btn-warning" href='/yls_app/goods_process' type="button">ProcessGoods</a><br>
      <a class="btn btn-warning" href='/yls_app/goodsgroup_process' type="button">ProcessGoods_Group</a><br>
      <a  class="btn btn-primary" href='/yls_app/clear_topics' type="button">清除结果</a>
      <a  class="btn btn-default" href='/yls_app/view_topics' type="button">查看结果</a>
      <a  class="btn btn-warning" href='/yls_app/view_at_topics' type="button">AT_Result</a>
      <a  class="btn btn-default" href='/yls_app/view_iat_topics' type="button">IAT_Result</a>
      <a  class="btn btn-success" href='/yls_app/view_weibouser?rec=1' type="button">推荐商品</a>
  </div>
  <div class="col-md-9">
      当前抓取用户数: <a id="weibo_user_count">{{got_user_count}} </a> <br>
      当前用户关系结果: <a id="weibo_rel_count">{{got_relations_count}}  </a><br>
      当前微博条数: <a id="weibo_count">{{weibos_count}} </a><br>
      当前分词结果: <a id="weibo_tokened">{{tokened_count}} 已经分词 </a><br>
      <div class="panel panel-primary">
        <!-- Default panel contents -->
        <div class="panel-heading">最近任务状态
          <th><a id='refresh_task' class="btn btn-success" type="button">刷新任务</a></th>
          <th><a id='view_all_task' class="btn btn-danger" type="button">查看所有任务</a></th> 
        </div>
        <!-- Table -->
        <table class="table" border="1" id="table_tasks">
          <tr>            
            <th>任务类型</th>
            <th>任务状态</th>
            <th>起始时间</th>
            <th>结束时间</th>         
          </tr>
        </table>
      </div>
  </div>
</div>

<!-- THe modal to show all tasks -->
<div id="modal_show_all_tasks" class="modal fade">
  <div class="col-md-12">
      <div class="panel panel-success">
        <!-- Default panel contents -->
        <div class="panel-heading">所有任务状态
          <a class="btn btn-danger" onclick="$('#modal_show_all_tasks').modal('hide');" type="button">关闭</a>
        </div>
        <!-- Table -->
        <table class="table" border="1" id="table_tasks_modal">
          <tr>            
            <th>任务类型</th>
            <th>任务状态</th>
            <th>起始时间</th>
            <th>结束时间</th>
            <th>详细信息</th>        
          </tr>
        </table>
      </div>
  </div>  
</div>


{% endblock %}

{% block extra_js %}
<script>

function append_tr(max_line, max_col, data, table_name, tr_name)
{
  var count = 0;
  for (var task in data) {
    console.log(task);
    count += 1;
    var str_to_append = "<tr name = '"+tr_name+"'>";
    for(var value in data[task]) {
      //console.log(value);
      if (value >= max_col) break;
      str_to_append += "<td style='vertical-align:middle'>" + data[task][value] + "</td>";
    }
    str_to_append += "</tr>"
    $("#" + table_name).append(str_to_append)
    if (count >= max_line) return;
  }
}

$(document).ready(function(event){
{% if is_logged_in == False %}
  $('#add_weibo_button').click(function(event){
    window.location = "{{qq_login_url | safe}}";
  });
{% endif %}
  var type_cut = "TYPE_CUT";
  var type_lda = "TYPE_RUNLDA";
  var type_convert = 'TYPE_CONVERT_RAW_TOKEN';
  var max_entry = 4;
  $('#refresh_task').click(function(event){
    // remove the current view
    $("tr[name='task_']").remove();
    // get new view and append to the table
    $.get("/yls_app/get_tasks", {},
       function(data, textStatus) {
        append_tr(max_entry, 4, data, 'table_tasks', 'task_');
      }, "json" );
    // get other datas
    $('#weibo_count').html('获取中...');
    $.get("/yls_app/get_weibo_stats", {},
       function(data, textStatus) {
        $('#weibo_user_count').html(data['weibo_user_count']);
        $('#weibo_rel_count').html(data['weibo_rel_count']);
        $('#weibo_count').html(data['weibo_count']);
        $('#weibo_tokened').html(data['weibo_tokened']);
      }, "json" );    
  });

  $('#view_all_task').click(function(event) {
    $.get("/yls_app/get_tasks", {},
       function(data, textStatus) {
        $("tr[name='task_modal_']").remove();
        append_tr(40, 5, data, 'table_tasks_modal', 'task_modal_');
        $('#modal_show_all_tasks').modal('show');
       },"json" );
  });

  $('#refresh_task').click(); //Trigger to get task status
});
</script>
{% endblock %}

